name: Auto-Clean

on:
  workflow_run:
    workflows: ["B70"]  # âœ… åªä¿ç•™å®žé™…å­˜åœ¨çš„å·¥ä½œæµåç§°,å¯ç›‘æŽ§å¤šä¸ªæµ["1","2",...]
    types:
      - completed
      
  # å®šæ—¶æ‰§è¡Œï¼šæ¯å‘¨ä¸‰é›¶ç‚¹æ‰§è¡Œ
  schedule:
    - cron: '0 0 * * 3'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      keep_releases:
        description: 'ä¿ç•™æœ€è¿‘å‡ ä¸ªæˆåŠŸçš„Release'
        default: '6'
        type: string
      keep_workflow_runs:
        description: 'ä¿ç•™æœ€è¿‘å‡ ä¸ªå·¥ä½œæµè¿è¡Œè®°å½•'
        default: '6'
        type: string

permissions:
  contents: write
  actions: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    # é‡è¦ï¼šé¿å…é€’å½’è§¦å‘ - å¦‚æžœæ˜¯ç”±Auto-Cleanè§¦å‘çš„å°±è·³è¿‡
    if: >
      github.event.workflow_run.name != 'Auto-Clean' || 
      github.event_name == 'schedule' || 
      github.event_name == 'workflow_dispatch'
    steps:
      # æ­¥éª¤1: æ¸…ç†æ—§çš„Releases
      - name: Cleanup Old Releases
        uses: actions/github-script@v7
        with:
          script: |
            // å¤„ç†ä¸åŒäº‹ä»¶çš„è¾“å…¥å‚æ•°
            const keepReleases = context.eventName === 'workflow_dispatch' 
              ? parseInt('${{ inputs.keep_releases }}') 
              : 6;
              
            console.log(`è§¦å‘äº‹ä»¶: ${context.eventName}`);
            console.log(`ðŸ—‘ï¸ å¼€å§‹æ¸…ç†Releasesï¼Œä¿ç•™æœ€è¿‘ ${keepReleases} ä¸ª`);
            
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            console.log(`ðŸ“¦ æ‰¾åˆ° ${releases.data.length} ä¸ªRelease`);

            const sortedReleases = releases.data.sort((a, b) => 
              new Date(b.created_at) - new Date(a.created_at)
            );

            let deletedReleases = 0;
            for (let i = keepReleases; i < sortedReleases.length; i++) {
              const release = sortedReleases[i];
              try {
                console.log(`ðŸ—‘ï¸ åˆ é™¤Release: ${release.tag_name}`);
                await github.rest.repos.deleteRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: release.id
                });
                deletedReleases++;
              } catch (error) {
                console.log(`âŒ åˆ é™¤Releaseå¤±è´¥: ${release.tag_name}`);
              }
            }
            console.log(`âœ… Releasesæ¸…ç†å®Œæˆ: åˆ é™¤äº† ${deletedReleases} ä¸ª`);

      # æ­¥éª¤2: æ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•ï¼ˆå®Œå…¨åˆ é™¤Auto-Cleanè®°å½•ï¼‰
      - name: Cleanup Workflow Runs
        uses: actions/github-script@v7
        with:
          script: |
            const keepWorkflowRuns = context.eventName === 'workflow_dispatch' 
              ? parseInt('${{ inputs.keep_workflow_runs }}') 
              : 6;
              
            console.log(`ðŸ—‘ï¸ å¼€å§‹æ¸…ç†å·¥ä½œæµè®°å½•ï¼Œä¿ç•™æœ€è¿‘ ${keepWorkflowRuns} ä¸ªå…¶ä»–å·¥ä½œæµï¼Œå®Œå…¨åˆ é™¤Auto-Cleanè®°å½•`);
            
            const workflows = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            // åˆ†ç¦»Auto-Cleanå’Œå…¶ä»–å·¥ä½œæµ
            const autoCleanRuns = workflows.data.workflow_runs.filter(run => 
              run.name === 'Auto-Clean'
            );
            
            const otherWorkflowRuns = workflows.data.workflow_runs.filter(run => 
              run.name !== 'Auto-Clean'
            );

            console.log(`ðŸ“Š æ‰¾åˆ° ${autoCleanRuns.length} ä¸ªAuto-Cleanè¿è¡Œè®°å½•`);
            console.log(`ðŸ“Š æ‰¾åˆ° ${otherWorkflowRuns.length} ä¸ªå…¶ä»–å·¥ä½œæµè¿è¡Œè®°å½•`);

            // å¯¹å…¶ä»–å·¥ä½œæµæŽ’åºå¹¶ä¿ç•™æŒ‡å®šæ•°é‡
            const sortedOtherWorkflows = otherWorkflowRuns.sort((a, b) => 
              new Date(b.created_at) - new Date(a.created_at)
            );

            let deletedOtherWorkflows = 0;
            for (let i = keepWorkflowRuns; i < sortedOtherWorkflows.length; i++) {
              const run = sortedOtherWorkflows[i];
              try {
                console.log(`ðŸ—‘ï¸ åˆ é™¤å…¶ä»–å·¥ä½œæµè®°å½•: #${run.id} ${run.name} (${run.conclusion})`);
                await github.rest.actions.deleteWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id
                });
                deletedOtherWorkflows++;
              } catch (error) {
                console.log(`âŒ åˆ é™¤å·¥ä½œæµè®°å½•å¤±è´¥: #${run.id}`);
              }
            }

            // åˆ é™¤æ‰€æœ‰Auto-Cleanè¿è¡Œè®°å½•ï¼ˆåŒ…æ‹¬å½“å‰è¿è¡Œçš„é™¤å¤–ï¼‰
            let deletedAutoClean = 0;
            for (const run of autoCleanRuns) {
              if (run.id === ${{ github.run_id }}) {
                console.log(`â­ï¸ è·³è¿‡å½“å‰è¿è¡Œçš„Auto-Cleanè®°å½•: #${run.id}`);
                continue;
              }
              try {
                console.log(`ðŸ—‘ï¸ åˆ é™¤Auto-Cleanè®°å½•: #${run.id} (${run.conclusion})`);
                await github.rest.actions.deleteWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id
                });
                deletedAutoClean++;
              } catch (error) {
                console.log(`âŒ åˆ é™¤Auto-Cleanè®°å½•å¤±è´¥: #${run.id}`);
              }
            }

            console.log(`âœ… å·¥ä½œæµè®°å½•æ¸…ç†å®Œæˆ:`);
            console.log(`   - åˆ é™¤äº† ${deletedOtherWorkflows} ä¸ªå…¶ä»–å·¥ä½œæµè®°å½•`);
            console.log(`   - åˆ é™¤äº† ${deletedAutoClean} ä¸ªAuto-Cleanè®°å½•`);
            console.log(`   - ä¿ç•™äº† ${Math.min(keepWorkflowRuns, sortedOtherWorkflows.length)} ä¸ªæœ€æ–°å…¶ä»–å·¥ä½œæµè®°å½•`);
            console.log(`   - Auto-Cleanè®°å½•å®Œå…¨åˆ é™¤ï¼ˆå½“å‰è¿è¡Œé™¤å¤–ï¼‰`);
