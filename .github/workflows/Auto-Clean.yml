name: Auto-Clean

on:
  workflow_run:
    workflows: ["B70"]  # âœ… åªä¿ç•™å®é™…å­˜åœ¨çš„å·¥ä½œæµåç§°,å¯ç›‘æ§å¤šä¸ªæµ["1","2",...]
    types:
      - completed
      
  # å®šæ—¶æ‰§è¡Œï¼šæ¯å‘¨ä¸‰é›¶ç‚¹æ‰§è¡Œ
  schedule:
    - cron: '0 0 * * 3'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      keep_releases:
        description: 'ä¿ç•™æœ€è¿‘å‡ ä¸ªæˆåŠŸçš„Release'
        default: '6'
        type: string
      keep_workflow_runs:
        description: 'ä¿ç•™æœ€è¿‘å‡ ä¸ªå·¥ä½œæµè¿è¡Œè®°å½•'
        default: '6'
        type: string

permissions:
  contents: write
  actions: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    # é‡è¦ï¼šé¿å…é€’å½’è§¦å‘ - å¦‚æœæ˜¯ç”±Auto-Cleanè§¦å‘çš„å°±è·³è¿‡
    if: >
      github.event.workflow_run.name != 'Auto-Clean' || 
      github.event_name == 'schedule' || 
      github.event_name == 'workflow_dispatch'
    steps:
      # æ­¥éª¤1: æ¸…ç†æ—§çš„Releases
      - name: Cleanup Old Releases
        uses: actions/github-script@v7
        with:
          script: |
            // è·å–è§¦å‘ä¿¡æ¯
            console.log(`è§¦å‘äº‹ä»¶: ${context.eventName}`);
            if (context.eventName === 'workflow_run') {
              console.log(`ç”±å·¥ä½œæµè§¦å‘: ${context.payload.workflow_run.name}`);
            }
            
            const keepReleases = '${{ inputs.keep_releases }}' ? parseInt('${{ inputs.keep_releases }}') : 6;
            console.log(`ğŸ—‘ï¸ å¼€å§‹æ¸…ç†Releasesï¼Œä¿ç•™æœ€è¿‘ ${keepReleases} ä¸ª`);
            
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            console.log(`ğŸ“¦ æ‰¾åˆ° ${releases.data.length} ä¸ªRelease`);

            const sortedReleases = releases.data.sort((a, b) => 
              new Date(b.created_at) - new Date(a.created_at)
            );

            let deletedReleases = 0;
            for (let i = keepReleases; i < sortedReleases.length; i++) {
              const release = sortedReleases[i];
              try {
                console.log(`ğŸ—‘ï¸ åˆ é™¤Release: ${release.tag_name}`);
                await github.rest.repos.deleteRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: release.id
                });
                deletedReleases++;
              } catch (error) {
                console.log(`âŒ åˆ é™¤Releaseå¤±è´¥: ${release.tag_name}`);
              }
            }
            console.log(`âœ… Releasesæ¸…ç†å®Œæˆ: åˆ é™¤äº† ${deletedReleases} ä¸ª`);

      # æ­¥éª¤2: æ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•ï¼ˆæ’é™¤Auto-Cleanè‡ªèº«ï¼‰
      - name: Cleanup Workflow Runs
        uses: actions/github-script@v7
        with:
          script: |
            const keepWorkflowRuns = '${{ inputs.keep_workflow_runs }}' ? parseInt('${{ inputs.keep_workflow_runs }}') : 6;
            console.log(`ğŸ—‘ï¸ å¼€å§‹æ¸…ç†å·¥ä½œæµè®°å½•ï¼Œä¿ç•™æœ€è¿‘ ${keepWorkflowRuns} ä¸ª`);
            
            const workflows = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            // è¿‡æ»¤æ‰Auto-Cleanè‡ªèº«å’Œå½“å‰è¿è¡Œ
            const filteredWorkflows = workflows.data.workflow_runs.filter(run => 
              run.name !== 'Auto-Clean' && 
              run.id !== ${{ github.run_id }}
            );

            const sortedWorkflows = filteredWorkflows.sort((a, b) => 
              new Date(b.created_at) - new Date(a.created_at)
            );

            let deletedWorkflows = 0;
            for (let i = keepWorkflowRuns; i < sortedWorkflows.length; i++) {
              const run = sortedWorkflows[i];
              try {
                console.log(`ğŸ—‘ï¸ åˆ é™¤å·¥ä½œæµè®°å½•: #${run.id} ${run.name} (${run.conclusion})`);
                await github.rest.actions.deleteWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id
                });
                deletedWorkflows++;
              } catch (error) {
                console.log(`âŒ åˆ é™¤å·¥ä½œæµè®°å½•å¤±è´¥: #${run.id}`);
              }
            }
            console.log(`âœ… å·¥ä½œæµè®°å½•æ¸…ç†å®Œæˆ: åˆ é™¤äº† ${deletedWorkflows} ä¸ª`);

      # æ­¥éª¤3: åˆ é™¤æ‰€æœ‰Auto-Cleanè®°å½•ï¼ˆä¿ç•™å½“å‰è¿è¡Œï¼‰
      - name: Delete All Auto-Clean Records
        uses: actions/github-script@v7
        with:
          script: |
            console.log(`ğŸ”¥ å¼€å§‹åˆ é™¤æ‰€æœ‰Auto-Cleanå·¥ä½œæµçš„è¿è¡Œè®°å½•`);
            
            const allRuns = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            // æ’é™¤å½“å‰è¿è¡Œï¼Œé¿å…åˆ é™¤è‡ªå·±
            const autoCleanRuns = allRuns.data.workflow_runs.filter(run => 
              (run.name === 'Auto-Clean' || run.path.includes('Auto-Clean.yml')) &&
              run.id !== ${{ github.run_id }}
            );

            console.log(`ğŸ“Š æ‰¾åˆ° ${autoCleanRuns.length} ä¸ªAuto-Cleanè¿è¡Œè®°å½•ï¼ˆæ’é™¤å½“å‰è¿è¡Œï¼‰`);

            let deletedAutoClean = 0;
            for (const run of autoCleanRuns) {
              try {
                console.log(`ğŸ”¥ åˆ é™¤Auto-Cleanè®°å½•: #${run.id} (${run.conclusion || 'unknown'})`);
                await github.rest.actions.deleteWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id
                });
                deletedAutoClean++;
              } catch (error) {
                console.log(`âŒ åˆ é™¤Auto-Cleanè®°å½•å¤±è´¥: #${run.id} - ${error.message}`);
              }
            }
            console.log(`âœ… Auto-Cleanè®°å½•æ¸…ç†å®Œæˆ: åˆ é™¤äº† ${deletedAutoClean} ä¸ª`);
