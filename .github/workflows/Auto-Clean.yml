name: Auto-Clean

on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯å‘¨ä¸‰é›¶ç‚¹æ‰§è¡Œ
  schedule:
    - cron: '0 0 * * 3'
  
  # æ‰‹åŠ¨è§¦å‘ï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼‰
  workflow_dispatch:
    inputs:
      keep_releases:
        description: 'ä¿ç•™æœ€è¿‘å‡ ä¸ªæˆåŠŸçš„Release'
        default: '5'
        type: string
      keep_workflow_runs:
        description: 'ä¿ç•™æœ€è¿‘å‡ ä¸ªå·¥ä½œæµè¿è¡Œè®°å½•'
        default: '5'
        type: string

permissions:
  contents: write
  actions: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1: æ¸…ç†æ—§çš„Releases
      - name: Cleanup Old Releases
        uses: actions/github-script@v7
        with:
          script: |
            // æ‰‹åŠ¨è¿è¡Œæ—¶ä½¿ç”¨è¾“å…¥å€¼ï¼Œå®šæ—¶æ‰§è¡Œæ—¶ä½¿ç”¨é»˜è®¤å€¼
            const keepReleases = '${{ inputs.keep_releases }}' ? parseInt('${{ inputs.keep_releases }}') : 5;
            console.log(`ğŸ—‘ï¸ å¼€å§‹æ¸…ç†Releasesï¼Œä¿ç•™æœ€è¿‘ ${keepReleases} ä¸ª`);
            
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            console.log(`ğŸ“¦ æ‰¾åˆ° ${releases.data.length} ä¸ªRelease`);

            const sortedReleases = releases.data.sort((a, b) => 
              new Date(b.created_at) - new Date(a.created_at)
            );

            let deletedReleases = 0;
            for (let i = keepReleases; i < sortedReleases.length; i++) {
              const release = sortedReleases[i];
              try {
                console.log(`ğŸ—‘ï¸ åˆ é™¤Release: ${release.tag_name}`);
                await github.rest.repos.deleteRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: release.id
                });
                deletedReleases++;
              } catch (error) {
                console.log(`âŒ åˆ é™¤Releaseå¤±è´¥: ${release.tag_name}`);
              }
            }
            console.log(`âœ… Releasesæ¸…ç†å®Œæˆ: åˆ é™¤äº† ${deletedReleases} ä¸ª`);

      # æ­¥éª¤2: æ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•
      - name: Cleanup Workflow Runs
        uses: actions/github-script@v7
        with:
          script: |
            const keepWorkflowRuns = '${{ inputs.keep_workflow_runs }}' ? parseInt('${{ inputs.keep_workflow_runs }}') : 5;
            console.log(`ğŸ—‘ï¸ å¼€å§‹æ¸…ç†å·¥ä½œæµè®°å½•ï¼Œä¿ç•™æœ€è¿‘ ${keepWorkflowRuns} ä¸ª`);
            
            // è·å–æ‰€æœ‰å·¥ä½œæµè¿è¡Œè®°å½•
            const workflows = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            const sortedWorkflows = workflows.data.workflow_runs.sort((a, b) => 
              new Date(b.created_at) - new Date(a.created_at)
            );

            // åˆ é™¤æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
            let deletedWorkflows = 0;
            for (let i = keepWorkflowRuns; i < sortedWorkflows.length; i++) {
              const run = sortedWorkflows[i];
              try {
                console.log(`ğŸ—‘ï¸ åˆ é™¤å·¥ä½œæµè®°å½•: #${run.id} ${run.name} (${run.conclusion})`);
                await github.rest.actions.deleteWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id
                });
                deletedWorkflows++;
              } catch (error) {
                console.log(`âŒ åˆ é™¤å·¥ä½œæµè®°å½•å¤±è´¥: #${run.id}`);
              }
            }
            console.log(`âœ… å·¥ä½œæµè®°å½•æ¸…ç†å®Œæˆ: åˆ é™¤äº† ${deletedWorkflows} ä¸ª`);

      # æ­¥éª¤3: ä¸“é—¨åˆ é™¤æ‰€æœ‰Auto-Cleanè‡ªèº«çš„è®°å½•ï¼ˆæ–°å¢ï¼‰
      - name: Delete All Auto-Clean Records
        uses: actions/github-script@v7
        with:
          script: |
            console.log(`ğŸ”¥ å¼€å§‹åˆ é™¤æ‰€æœ‰Auto-Cleanå·¥ä½œæµçš„è¿è¡Œè®°å½•`);
            
            // è·å–æ‰€æœ‰å·¥ä½œæµè¿è¡Œè®°å½•
            const allRuns = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            // ç­›é€‰å‡ºæ‰€æœ‰Auto-Cleançš„è®°å½•ï¼ˆä¸ç®¡æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰
            const autoCleanRuns = allRuns.data.workflow_runs.filter(run => 
              run.name === 'Auto-Clean' || run.path.includes('Auto-Clean.yml')
            );

            console.log(`ğŸ“Š æ‰¾åˆ° ${autoCleanRuns.length} ä¸ªAuto-Cleanè¿è¡Œè®°å½•`);

            // åˆ é™¤æ‰€æœ‰Auto-Cleanè®°å½•
            let deletedAutoClean = 0;
            for (const run of autoCleanRuns) {
              try {
                console.log(`ğŸ”¥ åˆ é™¤Auto-Cleanè®°å½•: #${run.id} (${run.conclusion || 'unknown'})`);
                await github.rest.actions.deleteWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id
                });
                deletedAutoClean++;
              } catch (error) {
                console.log(`âŒ åˆ é™¤Auto-Cleanè®°å½•å¤±è´¥: #${run.id} - ${error.message}`);
              }
            }
            console.log(`âœ… Auto-Cleanè®°å½•æ¸…ç†å®Œæˆ: åˆ é™¤äº† ${deletedAutoClean} ä¸ª`);
