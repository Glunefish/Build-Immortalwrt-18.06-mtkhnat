name: Auto Clean

on:
  workflow_run:
    workflows: ["B70"]  # æ›¿æ¢ä¸ºå®é™…çš„å·¥ä½œæµåç§°,å¤šä¸ªå¯["1","2","3"] ""ä¸­é—´ä¸å¯ä¸ºç©º
    types:
      - completed
      
  workflow_call:
    inputs:
      keep_releases:
        description: 'ä¿ç•™Releasesæ•°é‡'
        required: false
        type: number
        default: 5
      keep_workflow_runs:
        description: 'ä¿ç•™å·¥ä½œæµè®°å½•æ•°é‡'
        required: false
        type: number
        default: 5

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      # æ¸…ç† Releases
      - name: Remove old Releases
        uses: dev-drprasad/delete-older-releases@v0.2.1
        with:
          keep_latest: ${{ inputs.keep_releases }}
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ¸…ç†å·¥ä½œæµè®°å½•
      - name: Cleanup Workflow Runs
        uses: actions/github-script@v7
        with:
          script: |
            const keepWorkflowRuns = ${{ inputs.keep_workflow_runs }};
            
            console.log(`ğŸ—‘ï¸ å¼€å§‹æ¸…ç†å·¥ä½œæµè®°å½•ï¼Œä¿ç•™æœ€è¿‘ ${keepWorkflowRuns} æ¡`);
            
            const workflows = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            const filteredWorkflows = workflows.data.workflow_runs.filter(run => 
              run.id !== ${{ github.run_id }}
            );

            const sortedWorkflows = filteredWorkflows.sort((a, b) => 
              new Date(b.created_at) - new Date(a.created_at)
            );

            console.log(`ğŸ“Š æ‰¾åˆ° ${sortedWorkflows.length} æ¡å·¥ä½œæµè®°å½•`);

            let deletedCount = 0;
            for (let i = keepWorkflowRuns; i < sortedWorkflows.length; i++) {
              const run = sortedWorkflows[i];
              try {
                console.log(`ğŸ—‘ï¸ åˆ é™¤å·¥ä½œæµè®°å½•: #${run.id} ${run.name} (${run.conclusion || 'unknown'})`);
                await github.rest.actions.deleteWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id
                });
                deletedCount++;
              } catch (error) {
                console.log(`âŒ åˆ é™¤å¤±è´¥: #${run.id} - ${error.message}`);
              }
            }
            
            console.log(`âœ… å·¥ä½œæµè®°å½•æ¸…ç†å®Œæˆ: åˆ é™¤äº† ${deletedCount} æ¡`);
